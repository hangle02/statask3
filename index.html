<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Motor PID BLE Control</title>
</head>
<body>
  <h2>Motor PID Control via BLE</h2>
  <button onclick="connect()">Connect to ESP32</button><br><br>
  <label>Target RPM:</label>
  <input type="number" id="rpmInput" value="150" min="0" max="300">
  <button onclick="sendRPM()">Set RPM</button>
  <p id="status"></p>
  <p>Current RPM: <span id="currentRPM">?</span></p>
  <script>
    let bleDevice, bleChar;
    const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
    const CHAR_UUID = "abcdefab-1234-5678-1234-abcdefabcdef";

    async function connect() {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'ESP32 Motor Controller' }],
          optionalServices: [SERVICE_UUID]
        });
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleChar = await service.getCharacteristic(CHAR_UUID);
        document.getElementById('status').textContent = "Connected!";
        bleChar.startNotifications();
        bleChar.addEventListener('characteristicvaluechanged', handleNotify);
      } catch (err) {
        document.getElementById('status').textContent = "Connection failed: " + err;
      }
    }

    function sendRPM() {
      if (!bleChar) return;
      let rpm = document.getElementById('rpmInput').value;
      let encoder = new TextEncoder();
      bleChar.writeValue(encoder.encode(rpm));
      document.getElementById('status').textContent = "Sent target RPM: " + rpm;
    }

    function handleNotify(event) {
      let value = new TextDecoder().decode(event.target.value);
      document.getElementById('currentRPM').textContent = value;
    }
  </script>
</body>
</html>
